#!/bin/bash

# Initialize and update all submodules including themes
git submodule init
git submodule update

# Define items that should be linked to ~/.config
config_items=(
  "bat"
  "btop"
  "eza"
  "ghostty"
  "karabiner"
  "lazygit"
  "lsd"
  "nvim"
  "starship.toml"
  "tmuxinator"
)

# Base ignore list (items that shouldn't be symlinked to home at all)
base_ignorelist=(
  "com.camthompson.macos.updateip.plist"
  "README.md"
  "setup"
  "update"
  "themes"
)

# Combine base ignore list with config items for the full ignore list
not_ignored() {
  local ignorelist=("${base_ignorelist[@]}" "${config_items[@]}")
  for i in "${ignorelist[@]}"; do
    if [ "$1" = "$i" ]; then
      return 1
    fi
  done
  return 0
}

# Create .config directory and link config items
mkdir -p "$HOME/.config"
for item in "${config_items[@]}"; do
  if [ -e "$PWD/$item" ]; then
    rm -rf "$HOME/.config/$item"
    ln -s "$PWD/$item" "$HOME/.config/$item"
  fi
done

# Link everything else to home directory with dot prefix
for f in *; do
  if not_ignored "$f"; then
    # Only create symlink if it doesn't already exist or points to wrong location
    if [ ! -L "$HOME/.$f" ] || [ "$(readlink "$HOME/.$f")" != "$PWD/$f" ]; then
      rm -rf "$HOME/.$f"
      ln -s "$PWD/$f" "$HOME/.$f"
    fi
  fi
done

# Set up theme files from submodules
echo "Setting up Catppuccin themes..."

# bat theme setup
if [ -d "themes/catppuccin-bat" ]; then
  mkdir -p "bat/themes"
  ln -sf "$PWD/themes/catppuccin-bat/themes/Catppuccin Mocha.tmTheme" "bat/themes/Catppuccin Mocha.tmTheme"
  echo "  ✓ bat theme linked"
  # Rebuild bat cache for new theme
  if command -v bat &>/dev/null; then
    bat cache --build &>/dev/null && echo "  ✓ bat cache rebuilt"
  fi
fi

# btop theme setup
if [ -d "themes/catppuccin-btop" ]; then
  mkdir -p "btop/themes"
  ln -sf "$PWD/themes/catppuccin-btop/themes/catppuccin_mocha.theme" "btop/themes/catppuccin_mocha.theme"
  echo "  ✓ btop theme linked"
fi

# eza theme setup (using mocha-mauve variant)
if [ -d "themes/catppuccin-eza" ]; then
  ln -sf "$PWD/themes/catppuccin-eza/themes/mocha/catppuccin-mocha-mauve.yml" "eza/theme.yml"
  echo "  ✓ eza theme linked (mocha-mauve)"
fi

# lsd theme setup
if [ -d "themes/catppuccin-lsd" ]; then
  ln -sf "$PWD/themes/catppuccin-lsd/themes/catppuccin-mocha/colors.yaml" "lsd/colors.yaml"
  echo "  ✓ lsd theme linked"
fi

# ghostty theme setup
if [ -d "themes/catppuccin-ghostty" ]; then
  mkdir -p "ghostty/themes"
  ln -sf "$PWD/themes/catppuccin-ghostty/themes/catppuccin-mocha.conf" "ghostty/themes/catppuccin-mocha.conf"
  ln -sf "$PWD/themes/catppuccin-ghostty/themes/catppuccin-latte.conf" "ghostty/themes/catppuccin-latte.conf"

  echo "  ✓ ghostty themes linked (mocha for dark mode, latte for light mode)"
fi

# fast-syntax-highlighting theme setup
if [ -d "themes/catppuccin-fsh" ]; then
  mkdir -p "$HOME/.config/fsh"
  ln -sf "$PWD/themes/catppuccin-fsh/themes/catppuccin-mocha.ini" "$HOME/.config/fsh/catppuccin-mocha.ini"
  echo "  ✓ fast-syntax-highlighting theme linked"
fi

# fzf theme setup
if [ -d "themes/catppuccin-fzf" ]; then
  mkdir -p "zsh"
  ln -sf "$PWD/themes/catppuccin-fzf/themes/catppuccin-fzf-mocha.sh" "zsh/catppuccin-fzf.sh"
  echo "  ✓ fzf theme linked"
fi

# lazygit theme setup
if [ -d "themes/catppuccin-lazygit" ]; then
  ln -sf "$PWD/themes/catppuccin-lazygit/themes/mocha/mauve.yml" "lazygit/config.yml"
  echo "  ✓ lazygit theme linked (mocha-mauve)"
fi

# starship theme setup
if [ -d "themes/catppuccin-starship" ]; then
  # Remove everything after the theme marker and append new theme
  theme_marker="# === CATPPUCCIN THEME START (auto-generated, do not edit below) ==="
  if grep -q "$theme_marker" "starship.toml" 2>/dev/null; then
    # Remove old theme section
    sed -i.bak "/$theme_marker/,\$d" "starship.toml"
  fi
  # Append theme marker and content (no extra blank line if file already ends with newline)
  if [ -s "starship.toml" ] && [ "$(tail -c1 "starship.toml" | wc -l)" -eq 0 ]; then
    echo "" >>"starship.toml"
  fi
  echo "$theme_marker" >>"starship.toml"
  cat "themes/catppuccin-starship/themes/mocha.toml" >>"starship.toml"
  echo "  ✓ starship theme applied"
fi
