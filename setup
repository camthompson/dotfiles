#!/bin/bash

# Ensure we're running from the dotfiles repo root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR" || exit 1

if [ ! -f "setup" ] || [ ! -f "zshrc" ]; then
  echo "Error: must run from dotfiles repository root" >&2
  exit 1
fi

echo "This will overwrite existing dotfiles in ~ and ~/.config/ with symlinks to this repo."
echo -n "Are you sure you want to continue? Type 'yes' to confirm: "
read confirmation
if [ "$confirmation" != "yes" ]; then
  echo "Aborted."
  exit 1
fi

# Initialize and update all submodules including themes
git submodule init
git submodule update

# Define items that should be linked to ~/.config
config_items=(
  "bat"
  "btop"
  "eza"
  "ghostty"
  "karabiner"
  "lsd"
  "nvim"
  "starship.toml"
  "tmuxinator"
)

# Base ignore list (items that shouldn't be symlinked to home at all)
base_ignorelist=(
  "com.camthompson.macos.updateip.plist"
  "k9s"
  "lazygit"
  "README.md"
  "Brewfile"
  "demo.tsx"
  "screenshot.png"
  "setup"
  "update"
  "themes"
)

# Combine base ignore list with config items for the full ignore list
not_ignored() {
  local ignorelist=("${base_ignorelist[@]}" "${config_items[@]}")
  for i in "${ignorelist[@]}"; do
    if [ "$1" = "$i" ]; then
      return 1
    fi
  done
  return 0
}

# Create .config directory and link config items
mkdir -p "$HOME/.config"
for item in "${config_items[@]}"; do
  if [ -e "$PWD/$item" ]; then
    rm -rf "$HOME/.config/$item"
    ln -s "$PWD/$item" "$HOME/.config/$item"
  fi
done

# Special handling for lazygit (macOS uses ~/Library/Application Support/lazygit)
if [ -d "lazygit" ]; then
  lazygit_config_dir="$HOME/Library/Application Support/lazygit"
  if [ ! -L "$lazygit_config_dir" ] || [ "$(readlink "$lazygit_config_dir")" != "$PWD/lazygit" ]; then
    rm -rf "$lazygit_config_dir"
    ln -s "$PWD/lazygit" "$lazygit_config_dir"
  fi
fi

# Link everything else to home directory with dot prefix
for f in *; do
  if not_ignored "$f"; then
    # Only create symlink if it doesn't already exist or points to wrong location
    if [ ! -L "$HOME/.$f" ] || [ "$(readlink "$HOME/.$f")" != "$PWD/$f" ]; then
      rm -rf "$HOME/.$f"
      ln -s "$PWD/$f" "$HOME/.$f"
    fi
  fi
done

# Set up theme files from submodules
echo "Setting up Catppuccin themes..."

# bat theme setup
if [ -d "themes/catppuccin-bat" ]; then
  mkdir -p "bat/themes"
  ln -sf "$PWD/themes/catppuccin-bat/themes/Catppuccin Mocha.tmTheme" "bat/themes/Catppuccin Mocha.tmTheme"
  echo "  ✓ bat theme linked"
  # Rebuild bat cache for new theme
  if command -v bat &>/dev/null; then
    bat cache --build &>/dev/null && echo "  ✓ bat cache rebuilt"
  fi
fi

# btop theme setup
if [ -d "themes/catppuccin-btop" ]; then
  mkdir -p "btop/themes"
  ln -sf "$PWD/themes/catppuccin-btop/themes/catppuccin_mocha.theme" "btop/themes/catppuccin_mocha.theme"
  echo "  ✓ btop theme linked"
fi

# eza theme setup (using mocha-mauve variant)
if [ -d "themes/catppuccin-eza" ]; then
  ln -sf "$PWD/themes/catppuccin-eza/themes/mocha/catppuccin-mocha-mauve.yml" "eza/theme.yml"
  echo "  ✓ eza theme linked (mocha-mauve)"
fi

# lsd theme setup
if [ -d "themes/catppuccin-lsd" ]; then
  ln -sf "$PWD/themes/catppuccin-lsd/themes/catppuccin-mocha/colors.yaml" "lsd/colors.yaml"
  echo "  ✓ lsd theme linked"
fi

# ghostty theme setup
if [ -d "themes/catppuccin-ghostty" ]; then
  mkdir -p "ghostty/themes"
  ln -sf "$PWD/themes/catppuccin-ghostty/themes/catppuccin-mocha.conf" "ghostty/themes/catppuccin-mocha.conf"
  ln -sf "$PWD/themes/catppuccin-ghostty/themes/catppuccin-latte.conf" "ghostty/themes/catppuccin-latte.conf"

  echo "  ✓ ghostty themes linked (mocha for dark mode, latte for light mode)"
fi

# k9s config setup (macOS uses ~/Library/Application Support/k9s)
if [ -d "k9s" ]; then
  k9s_dir="$HOME/Library/Application Support/k9s"
  mkdir -p "$k9s_dir" "$k9s_dir/skins"
  ln -sf "$PWD/k9s/config.yaml" "$k9s_dir/config.yaml"
  ln -sf "$PWD/k9s/aliases.yaml" "$k9s_dir/aliases.yaml"
  if [ -d "themes/catppuccin-k9s" ]; then
    ln -sf "$PWD/themes/catppuccin-k9s/dist/catppuccin-mocha.yaml" "$k9s_dir/skins/catppuccin-mocha.yaml"
    echo "  ✓ k9s theme linked"
  fi
  echo "  ✓ k9s config linked"
fi

# fast-syntax-highlighting theme setup
if [ -d "themes/catppuccin-fsh" ]; then
  mkdir -p "$HOME/.config/fsh"
  ln -sf "$PWD/themes/catppuccin-fsh/themes/catppuccin-mocha.ini" "$HOME/.config/fsh/catppuccin-mocha.ini"
  echo "  ✓ fast-syntax-highlighting theme linked"
fi

# fzf theme setup
if [ -d "themes/catppuccin-fzf" ]; then
  mkdir -p "zsh"
  ln -sf "$PWD/themes/catppuccin-fzf/themes/catppuccin-fzf-mocha.sh" "zsh/catppuccin-fzf.sh"
  echo "  ✓ fzf theme linked"
fi

# lazygit theme setup
if [ -d "themes/catppuccin-lazygit" ]; then
  # Remove everything after the theme marker and append new theme
  theme_marker="# === CATPPUCCIN THEME START (auto-generated, do not edit below) ==="
  if grep -q "$theme_marker" "lazygit/config.yml" 2>/dev/null; then
    # Remove old theme section
    sed -i.bak "/$theme_marker/,\$d" "lazygit/config.yml"
  fi
  # Append theme marker and content
  if [ -s "lazygit/config.yml" ] && [ "$(tail -c1 "lazygit/config.yml" | wc -l)" -eq 0 ]; then
    echo "" >>"lazygit/config.yml"
  fi
  echo "$theme_marker" >>"lazygit/config.yml"
  cat "themes/catppuccin-lazygit/themes-mergable/mocha/mauve.yml" >>"lazygit/config.yml"
  echo "  ✓ lazygit config updated (mocha-mauve theme + delta pager)"
fi

# starship theme setup
if [ -d "themes/catppuccin-starship" ]; then
  # Remove everything after the theme marker and append new theme
  theme_marker="# === CATPPUCCIN THEME START (auto-generated, do not edit below) ==="
  if grep -q "$theme_marker" "starship.toml" 2>/dev/null; then
    # Remove old theme section
    sed -i.bak "/$theme_marker/,\$d" "starship.toml"
  fi
  # Append theme marker and content (no extra blank line if file already ends with newline)
  if [ -s "starship.toml" ] && [ "$(tail -c1 "starship.toml" | wc -l)" -eq 0 ]; then
    echo "" >>"starship.toml"
  fi
  echo "$theme_marker" >>"starship.toml"
  cat "themes/catppuccin-starship/themes/mocha.toml" >>"starship.toml"
  echo "  ✓ starship theme applied"
fi
